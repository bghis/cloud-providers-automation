data "aws_ami" "latest-windows-server-2022" {
most_recent = true
owners = ["801119661308"] # Windows

  filter {
      name   = "name"
      values = ["Windows_Server-2022-English-Full-Base-*"]
  }

  filter {
      name   = "virtualization-type"
      values = ["hvm"]
  }
}

resource "aws_network_interface" "ec2_nic" {
  subnet_id       = var.subnet_id
  security_groups = var.security_groups 
}

resource "aws_instance" "ec2" {
  ami              = "ami-0195a00deb1290da6"
  instance_type    = var.instance_type
  key_name         = var.key_name
  # user_data_base64 = "IyEvYmluL2Jhc2gKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8gIlVwZ3JhZGluZyBVYnVudHUgSW1hZ2UgYW5kIFBhY2thZ2VzIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobwpzdWRvIGFwdC1nZXQgLXkgdXBkYXRlCnN1ZG8gYXB0LWdldCAteSB1cGdyYWRlCnN1ZG8gYXB0LWdldCAteSBpbnN0YWxsIHNvZnR3YXJlLXByb3BlcnRpZXMtY29tbW9uIHppcCB1bnppcAplY2hvCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICJJbnN0YWxsIEt1YmVjdGwsIGVrc2N0bCBhbmQgSGVsbSIKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8KY3VybCAtTE8gImh0dHBzOi8vZGwuazhzLmlvL3JlbGVhc2UvJChjdXJsIC1MIC1zIGh0dHBzOi8vZGwuazhzLmlvL3JlbGVhc2Uvc3RhYmxlLnR4dCkvYmluL2xpbnV4L2FtZDY0L2t1YmVjdGwiCnN1ZG8gaW5zdGFsbCAtbyByb290IC1nIHJvb3QgLW0gMDc1NSBrdWJlY3RsIC91c3IvbG9jYWwvYmluL2t1YmVjdGwKY3VybCAtLXNpbGVudCAtLWxvY2F0aW9uICJodHRwczovL2dpdGh1Yi5jb20vd2VhdmV3b3Jrcy9la3NjdGwvcmVsZWFzZXMvbGF0ZXN0L2Rvd25sb2FkL2Vrc2N0bF8kKHVuYW1lIC1zKV9hbWQ2NC50YXIuZ3oiIHwgdGFyIHh6IC1DIC90bXAKc3VkbyBtdiAvdG1wL2Vrc2N0bCAvdXNyL2xvY2FsL2JpbgpzdWRvIHNuYXAgaW5zdGFsbCBoZWxtIC0tY2xhc3NpYwplY2hvCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICJJbnN0YWxsIERvY2tlciBhbmQgRG9ja2VyIENvbXBvc2UiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvCmN1cmwgLWZzU0wgaHR0cHM6Ly9nZXQuZG9ja2VyLmNvbSAtbyBnZXQtZG9ja2VyLnNoCnN1ZG8gc2ggZ2V0LWRvY2tlci5zaApzdWRvIHVzZXJtb2QgLWFHIGRvY2tlciB1YnVudHUKc3VkbyBhcHQtZ2V0IC15IGluc3RhbGwgZG9ja2VyLWNvbXBvc2UKZWNobwplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiSW5zdGFsbGluZyBBV1MgQ0xJIGFuZCBTZXNzaW9uIE1hbmFnZXIgcGx1Z2luIgplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobwpjdXJsICJodHRwczovL2F3c2NsaS5hbWF6b25hd3MuY29tL2F3c2NsaS1leGUtbGludXgteDg2XzY0LnppcCIgLW8gImF3c2NsaXYyLnppcCIKc3VkbyB1bnppcCBhd3NjbGl2Mi56aXAKc3VkbyAuL2F3cy9pbnN0YWxsCmN1cmwgImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9zZXNzaW9uLW1hbmFnZXItZG93bmxvYWRzL3BsdWdpbi9sYXRlc3QvdWJ1bnR1XzY0Yml0L3Nlc3Npb24tbWFuYWdlci1wbHVnaW4uZGViIiAtbyAic2Vzc2lvbi1tYW5hZ2VyLXBsdWdpbi5kZWIiCnN1ZG8gZHBrZyAtaSBzZXNzaW9uLW1hbmFnZXItcGx1Z2luLmRlYgplY2hvCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvICJJbnN0YWxsaW5nIE5vZGUgYW5kIE5QTSIKZWNobyAiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0iCmVjaG8KY3VybCAtZnNTTCBodHRwczovL2RlYi5ub2Rlc291cmNlLmNvbS9zZXR1cF8xOC54IHwgc3VkbyAtRSBiYXNoIC0Kc3VkbyBhcHQtZ2V0IHVwZGF0ZSAteQpzdWRvIGFwdC1nZXQgaW5zdGFsbCBub2RlanMgLXkKZWNobwplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiSW5zdGFsbGluZyBQb3N0Z3JlcyBjbGllbnQiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvCnN1ZG8gYXB0IGluc3RhbGwgLXkgcG9zdGdyZXNxbC1jbGllbnQKZWNobwplY2hvICI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSIKZWNobyAiRG9uZSBVYnVudHUgU2V0dXAiCmVjaG8gIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IgplY2hvCnN1ZG8gc2h1dGRvd24gLXIgMAplY2hvCg=="

  network_interface {
    network_interface_id = aws_network_interface.ec2_nic.id
    device_index         = 0
  }

  root_block_device {
    volume_size = var.osdisk_size
  }

  tags = {
    Name = var.hostname
  }
}